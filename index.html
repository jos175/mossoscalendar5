<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mossos calendar by JPL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .day-box { min-height: 90px; display:flex; flex-direction:column; justify-content:space-between; align-items:center; padding:8px; text-align:center; cursor:pointer; transition:transform 0.1s ease-in-out; }
        .day-box:hover { transform: scale(1.02); }
        .day-box.faded { opacity:0.5; cursor:pointer; transform:none; }
        .day-box.annotation-highlight { border-width:2px; border-color:#000; }
        .day-number { font-weight:600; font-size:1.25rem; }
        .day-shift { font-size:0.875rem; line-height:1; }
        .day-annotation { font-size:0.75rem; font-weight:500; color:#4B5563; padding-left:4px; padding-right:4px; padding-bottom:6px; word-wrap:break-word; line-height:1.1; }
        .button { padding:8px 16px; font-weight:500; border-radius:9999px; transition:background-color 0.15s ease-in-out; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:50; }
        .modal-content { background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1),0 10px 15px rgba(0,0,0,.1); width:90%; max-width:420px; text-align:center; }
        .modal-button { display:block; width:100%; padding:12px; margin-top:8px; border-radius:8px; background:#E5E7EB; color:#1F2937; font-weight:600; transition:background-color .15s; }
        .modal-button:hover { background:#D1D5DB; }
        .input-group { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .input-group label { font-weight:500; color:#4B5563; }
        .input-group input, .input-group textarea { width:45%; padding:8px; border-radius:8px; border:1px solid #D1D5DB; text-align:center; }
        .total-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #E5E7EB; }
        .total-item:last-child { border-bottom:none; }
        .total-item span:first-child { font-weight:500; color:#4B5563; }
        .total-item span:last-child { font-weight:600; color:#1F2937; }
        @media (max-width:640px) {
            .day-box { min-height:80px; padding:6px; }
            .day-number { font-size:1.1rem; }
            .day-shift { font-size:0.75rem; }
            .day-annotation { font-size:0.65rem; padding-bottom:2px; }
            h1 { font-size:1.75rem; }
        }
        .user-id { font-size:0.75rem; color:#6B7280; margin-top:1rem; text-align:center; word-break:break-all; }
        .status-message { margin-top:0.5rem; font-size:0.875rem; color:#4B5563; text-align:center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

  <div class="w-full max-w-4xl bg-white p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-200">
    <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-4 sm:mb-6">Mossos calendar by JPL</h1>

    <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0 md:space-x-4">
      <div class="flex-grow w-full md:w-auto">
        <label for="escamot-select" class="block text-sm font-medium text-gray-700 mb-1">Selecciona el teu Escamot</label>
        <select id="escamot-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
          <option value="1">Escamot 1</option>
          <option value="2">Escamot 2</option>
          <option value="3">Escamot 3</option>
          <option value="4">Escamot 4</option>
          <option value="5">Escamot 5</option>
        </select>
      </div>

      <div class="flex flex-grow w-full md:w-auto mt-4 md:mt-0 space-x-2">
        <div class="flex-1">
          <label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
          <select id="month-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
        </div>
        <div class="flex-1">
          <label for="year-select" class="block text-sm font-medium text-gray-700 mb-1">Any</label>
          <select id="year-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
        </div>
      </div>
    </div>

    <div class="flex justify-between mb-4">
      <button id="prev-month-btn" class="button bg-gray-300 hover:bg-gray-400 text-gray-800">&lt; Mes Anterior</button>
      <button id="today-btn" class="button bg-indigo-600 hover:bg-indigo-700 text-white">Avui</button>
      <button id="next-month-btn" class="button bg-gray-300 hover:bg-gray-400 text-gray-800">Mes Següent &gt;</button>
    </div>

    <div id="calendar-container">
      <div class="grid grid-cols-7 text-center font-bold text-gray-700 bg-gray-200 rounded-t-lg p-2">
        <div>Dill</div><div>Dim</div><div>Dmc</div><div>Dij</div><div>Div</div><div>Dis</div><div>Diu</div>
      </div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1 p-1 sm:p-2 bg-white rounded-b-lg border border-gray-200"></div>
    </div>

    <p class="status-message" id="status-message">Conectando...</p>
    <p class="user-id" id="user-id">ID de Usuario: Cargando...</p>

    <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
      <h2 id="summary-title" class="text-xl font-bold text-gray-800 mb-4">Resum Anual</h2>
      <div id="totals-display">
        <div class="total-item"><span>Total d'hores planificades:</span><span id="total-planned-hours">0 h</span></div>
        <div class="total-item"><span>Total d'hores treballades:</span><span id="total-worked-hours">0 h</span></div>
        <div class="total-item"><span>Total d'hores que s'han de treballar a l'any:</span><span id="total-annual-hours">1680 h</span></div>
        <div class="total-item"><span>Total de vacances:</span><span id="total-vacances-hours">0 h</span></div>
        <div class="total-item"><span>Total de dies treballats:</span><span id="total-worked-days">0 dies</span></div>
        <div class="total-item"><span>Total d'hores de perllongament:</span><span id="total-perllongament-hours">0 h 0 m</span></div>
        <div class="total-item"><span>Romanent per fer any:</span><span id="total-romanent-per-fer-hours" class="font-bold">0 h 0 m</span></div>
        <div class="total-item"><span>Romanent fet any:</span><span id="total-romanent-fet-hours" class="font-bold">0 h 0 m</span></div>
        <div class="total-item"><span>Total de judicis:</span><span id="total-judicis">0</span></div>
      </div>
    </div>
  </div>

  <!-- Modal anotació -->
  <div id="annotation-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-gray-800">Afegeix una anotació</h2>
      <div id="annotation-options" class="flex flex-col space-y-2">
        <button class="modal-button" data-annotation="Vacances">Vacances</button>
        <button class="modal-button" data-annotation="Perllongament">Perllongament</button>
        <button class="modal-button" data-annotation="Tir">Tir</button>
        <button class="modal-button" data-annotation="Formació">Formació</button>
        <button class="modal-button" data-annotation="Romanent">Romanent</button>
        <button class="modal-button" data-annotation="AP">AP</button>
        <button class="modal-button" data-annotation="Judici">Judici</button>
      </div>
      <button id="clear-annotation-btn" class="modal-button mt-4 bg-red-500 text-white hover:bg-red-600">Eliminar Anotació</button>
      <button id="close-modal-btn" class="modal-button mt-4 bg-gray-300 text-gray-800 hover:bg-gray-400">Tanca</button>
    </div>
  </div>

  <!-- Modal hores -->
  <div id="time-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="time-modal-title" class="text-xl font-bold mb-4 text-gray-800">Afegeix hores</h2>
      <div class="input-group">
        <label for="time-hours-input">Hores:</label>
        <input type="number" id="time-hours-input" value="0" min="0" class="rounded-md border-gray-300 p-2">
      </div>
      <div class="input-group">
        <label for="time-minutes-input">Minuts:</label>
        <input type="number" id="time-minutes-input" value="0" min="0" max="59" class="rounded-md border-gray-300 p-2">
      </div>
      <div id="time-modal-motivo-container" class="input-group flex-col items-start w-full">
        <label for="time-motivo-input" class="mb-2">Motiu:</label>
        <textarea id="time-motivo-input" rows="2" class="w-full rounded-md border-gray-300 p-2 resize-none text-center"></textarea>
      </div>
      <button id="save-time-btn" class="modal-button bg-green-500 text-white hover:bg-green-600">Desa</button>
      <button id="cancel-time-btn" class="modal-button mt-4 bg-gray-300 text-gray-800 hover:bg-gray-400">Cancel·la</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ====== CONFIGURA AQUI >>> Sustituye por tus credenciales de Firebase <<<< ======
    // Copia el objeto firebaseConfig desde la consola de Firebase (Configuración de la app web)
    const firebaseConfig = {
      apiKey: "AIzaSyCfwMOIDxQhFRkuMupsbSzGf5UKuRqe1aA",

  authDomain: "mossoscalendar.firebaseapp.com",

  projectId: "mossoscalendar",

  storageBucket: "mossoscalendar.firebasestorage.app",

  messagingSenderId: "357620337746",

  appId: "1:357620337746:web:46a8f42ad9c6fdafe3e38b",

  measurementId: "G-B15S9RY6B9"
    };
    // ==============================================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "mossos_calendar_by_jpl"; // ruta base usada en Firestore

    // UI elements
    const escamotSelect = document.getElementById('escamot-select');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const calendarGrid = document.getElementById('calendar-grid');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const todayBtn = document.getElementById('today-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const annotationModal = document.getElementById('annotation-modal');
    const annotationOptions = document.getElementById('annotation-options');
    const clearAnnotationBtn = document.getElementById('clear-annotation-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const timeModal = document.getElementById('time-modal');
    const timeModalTitle = document.getElementById('time-modal-title');
    const timeModalMotivoContainer = document.getElementById('time-modal-motivo-container');
    const timeHoursInput = document.getElementById('time-hours-input');
    const timeMinutesInput = document.getElementById('time-minutes-input');
    const timeMotivoInput = document.getElementById('time-motivo-input');
    const saveTimeBtn = document.getElementById('save-time-btn');
    const cancelTimeBtn = document.getElementById('cancel-time-btn');
    const totalPlannedHoursSpan = document.getElementById('total-planned-hours');
    const totalWorkedHoursSpan = document.getElementById('total-worked-hours');
    const totalVacancesHoursSpan = document.getElementById('total-vacances-hours');
    const totalWorkedDaysSpan = document.getElementById('total-worked-days');
    const totalPerllongamentHoursSpan = document.getElementById('total-perllongament-hours');
    const totalRomanentPerFerHoursSpan = document.getElementById('total-romanent-per-fer-hours');
    const totalRomanentFetHoursSpan = document.getElementById('total-romanent-fet-hours');
    const totalJudicisSpan = document.getElementById('total-judicis');
    const summaryTitle = document.getElementById('summary-title');
    const userIdDisplay = document.getElementById('user-id');
    const statusMessage = document.getElementById('status-message');

    // state
    let selectedDayDate = null;
    let currentAnnotationType = null;
    let annotations = {}; // mapa dateKey -> annotationData
    let userId = null;
    let unsubscribeAnnotations = null;
    let isAuthReady = false;

    // calendar helpers & config (mantén la logica que ya tenías)
    const months = ["Gener","Febrer","Març","Abril","Maig","Juny","Juliol","Agost","Setembre","Octubre","Novembre","Desembre"];
    const ESCAMOT_BASE_WEEK = {1:3,2:2,3:1,4:5,5:4}; // ajusta si hace falta
    const SHIFT_ABBREVIATIONS = {'Festa':'F','Matins':'M','Dia':'D','Tardes':'T','Nits':'N','Tarda/Nit':'TN'};
    const ANNOTATION_ABBREVIATIONS = {'Vacances':'VAC','Perllongament':'Per','Tir':'Tir','Formació':'Formació','Romanent':'Rom','AP':'AP','Judici':'J'};
    const ANNOTATION_FULL_NAMES = {'Vacances':'Vacances','Perllongament':'Perllongament','Tir':'Tir','Formació':'Formació','Romanent':'Romanent','AP':'AP','Judici':'Judici'};
    const SHIFT_HOURS = {'Matins':8.5,'Dia':12,'Tardes':8.5,'Nits':8.5,'Tarda/Nit':12,'Formació':8.5,'AP':8.5,'Tir':8.5,'Romanent':8.5,'Judici':8.5};
    const ANNUAL_WORK_HOURS = 1680;
    const VACATION_HOURS = 180;
    const ANCHOR_MONDAY = new Date('2025-01-27T00:00:00');
    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    function diffDays(a,b){ const utcA=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()); const utcB=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()); return Math.floor((utcA-utcB)/MS_PER_DAY); }
    function weekIndexForDate(date, escamot){ const days = diffDays(date, ANCHOR_MONDAY); const offsetWeeks = Math.floor(days/7); const base = ESCAMOT_BASE_WEEK[escamot] || 1; const idx = ((base - 1 + offsetWeeks) % 5 + 5) % 5; return idx + 1; }
    function getQ5Shift(date, escamot){ const weekIdx = weekIndexForDate(date, escamot); const day=date.getDay(); const isWeekend = day===0||day===6; switch(weekIdx){ case 1: case 4: return 'Festa'; case 2: return isWeekend ? 'Festa' : 'Tardes'; case 3: return isWeekend ? 'Tarda/Nit' : 'Nits'; case 5: return isWeekend ? 'Dia' : 'Matins'; default: return 'Festa'; } }
    function getShiftColors(shift){ switch(shift){ case 'Festa': return 'bg-green-200 border-green-300'; case 'Matins': case 'Dia': return 'bg-blue-200 border-blue-300'; case 'Tardes': return 'bg-yellow-200 border-yellow-300'; case 'Nits': case 'Tarda/Nit': return 'bg-red-200 border-red-300'; default: return 'bg-gray-200 border-gray-300'; } }

    // ---------- Firestore: rutas que incluyen escamot ----------
    // Guarda una anotación en /artifacts/{appId}/users/{userId}/escamots/{escamot}/annotations/{dateKey}
    async function saveAnnotation(dateKey, annotationData) {
      if (!userId) { statusMessage.textContent = "No autenticado aún."; return; }
      const escamot = escamotSelect.value;
      const docRef = doc(db, 'artifacts', appId, 'users', userId, 'escamots', escamot, 'annotations', dateKey);
      try {
        await setDoc(docRef, annotationData);
        statusMessage.textContent = "Anotación guardada.";
      } catch (err) {
        console.error("Error saving annotation:", err);
        statusMessage.textContent = "Error al guardar la anotación.";
      }
    }

    // Elimina una anotación en la ruta del escamot seleccionado
    async function deleteAnnotationForEscamot(dateKey) {
      if (!userId) { statusMessage.textContent = "No autenticado aún."; return; }
      const escamot = escamotSelect.value;
      const docRef = doc(db, 'artifacts', appId, 'users', userId, 'escamots', escamot, 'annotations', dateKey);
      try {
        await deleteDoc(docRef);
        statusMessage.textContent = "Anotación eliminada.";
      } catch (err) {
        console.error("Error deleting annotation:", err);
        statusMessage.textContent = "Error al eliminar la anotación.";
      }
    }

    // Subscribir a las anotaciones del escamot seleccionado (y cancelar la anterior)
    function subscribeAnnotations(escamot) {
      if (!userId) return;
      if (unsubscribeAnnotations) unsubscribeAnnotations();
      const colRef = collection(db, 'artifacts', appId, 'users', userId, 'escamots', escamot, 'annotations');
      unsubscribeAnnotations = onSnapshot(colRef, (snapshot) => {
        annotations = {};
        snapshot.forEach(d => { annotations[d.id] = d.data(); });
        renderCalendar();
      }, (error) => {
        console.error("Firestore error:", error);
        statusMessage.textContent = "Error al conectar con la base de datos.";
      });
    }

    // ---------- Calendar rendering ----------
    function populateMonthYearSelects(){
      monthSelect.innerHTML = months.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
      const currentYear = new Date().getFullYear();
      yearSelect.innerHTML = '';
      for (let i = currentYear-5; i<=currentYear+5; i++){
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = i;
        yearSelect.appendChild(opt);
      }
    }

    function renderCalendar(){
      const year = parseInt(yearSelect.value);
      const month = parseInt(monthSelect.value);
      if (isNaN(year) || isNaN(month)) return;
      calendarGrid.innerHTML = '';
      const firstDayDate = new Date(year, month, 1);
      const lastDayDate = new Date(year, month+1, 0);
      const startDayOffset = firstDayDate.getDay() === 0 ? 6 : firstDayDate.getDay()-1;
      const startDate = new Date(firstDayDate); startDate.setDate(startDate.getDate()-startDayOffset);
      const endDayOffset = lastDayDate.getDay() === 0 ? 0 : 7 - lastDayDate.getDay();
      const endDate = new Date(lastDayDate); endDate.setDate(endDate.getDate()+endDayOffset);

      let currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const day = currentDate.getDate();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        const escamot = parseInt(escamotSelect.value);
        const shift = getQ5Shift(currentDate, escamot);
        const abbreviatedShift = SHIFT_ABBREVIATIONS[shift] || shift;
        const isToday = currentDate.getFullYear() === new Date().getFullYear()
          && currentDate.getMonth() === new Date().getMonth()
          && currentDate.getDate() === new Date().getDate();

        const dateKey = currentDate.toISOString().split('T')[0];
        const annotation = annotations[dateKey] || null;

        const dayBox = document.createElement('div');
        dayBox.dataset.date = dateKey;
        dayBox.className = `day-box rounded-lg p-2 text-center shadow-sm border ${getShiftColors(shift)}`;
        if (currentMonth !== month || currentYear !== year) dayBox.classList.add('faded');
        let textClasses = isToday ? 'text-red-500 font-bold' : '';

        let annotationTextFull = ''; let annotationTextAbbrev = ''; let hoursMinutesText = '';
        if (annotation) {
          const t = annotation.type;
          annotationTextFull = ANNOTATION_FULL_NAMES[t] || t;
          annotationTextAbbrev = ANNOTATION_ABBREVIATIONS[t] || t;
          switch(t) {
            case 'Vacances':
              dayBox.className = 'day-box rounded-lg p-2 text-center shadow-sm border bg-purple-400 border-purple-600';
              textClasses = 'text-white font-bold';
              break;
            case 'Perllongament':
            case 'Romanent':
              dayBox.classList.add('annotation-highlight');
              if (annotation.motivo) dayBox.title = annotation.motivo;
              if (annotation.hours !== undefined && annotation.minutes !== undefined) hoursMinutesText = `<br>${annotation.hours}h ${annotation.minutes}m`;
              break;
            case 'AP':
              dayBox.className = 'day-box rounded-lg p-2 text-center shadow-sm border bg-fuchsia-400 border-fuchsia-600';
              textClasses = 'text-white font-bold';
              break;
            case 'Judici':
              dayBox.className = 'day-box rounded-lg p-2 text-center shadow-sm border bg-yellow-500 border-yellow-700';
              textClasses = 'text-white font-bold';
              break;
          }
        }

        dayBox.innerHTML = `
          <span class="day-number ${textClasses}">${day}</span>
          <span class="day-shift ${textClasses}">${abbreviatedShift}</span>
          <span class="day-annotation hidden sm:inline ${textClasses}">${annotationTextFull}${hoursMinutesText}</span>
          <span class="day-annotation inline sm:hidden ${textClasses}">${annotationTextAbbrev}${hoursMinutesText}</span>
        `;
        calendarGrid.appendChild(dayBox);
        currentDate.setDate(currentDate.getDate()+1);
      }

      calculateTotals();
    }

    function updateMonth(offset){
      let y = parseInt(yearSelect.value); let m = parseInt(monthSelect.value);
      const newDate = new Date(y, m + offset, 1);
      yearSelect.value = newDate.getFullYear(); monthSelect.value = newDate.getMonth();
      renderCalendar();
    }

    function goToToday(){
      const t = new Date();
      monthSelect.value = t.getMonth(); yearSelect.value = t.getFullYear();
      renderCalendar();
    }

    // Totals (la teva lógica original, sense canvis essencials)
    function calculateTotals(){
      const escamot = parseInt(escamotSelect.value);
      let totalPlannedHoursFixed = 0; let totalWorkedDaysFixed = 0;
      const startDateFixed = new Date('2025-02-01'); const endDateFixed = new Date('2026-01-31');
      const dayMs = 1000 * 60 * 60 * 24;
      let currentDateFixed = new Date(startDateFixed);
      while (currentDateFixed.getTime() <= endDateFixed.getTime()){
        const shift = getQ5Shift(currentDateFixed, escamot);
        if (shift !== 'Festa') { totalPlannedHoursFixed += (SHIFT_HOURS[shift] || 0); totalWorkedDaysFixed++; }
        currentDateFixed.setTime(currentDateFixed.getTime() + dayMs);
      }

      let totalPerllongamentHours=0, totalPerllongamentMinutes=0, totalRomanentHours=0, totalRomanentMinutes=0, totalJuicios=0;
      for (const d in annotations){
        const a = annotations[d];
        if (!a || !a.type) continue;
        if (a.type === 'Perllongament'){ totalPerllongamentHours += a.hours || 0; totalPerllongamentMinutes += a.minutes || 0; }
        if (a.type === 'Romanent'){ totalRomanentHours += a.hours || 0; totalRomanentMinutes += a.minutes || 0; }
        if (a.type === 'Judici') totalJuicios++;
      }
      totalPerllongamentHours += Math.floor(totalPerllongamentMinutes / 60); totalPerllongamentMinutes %= 60;
      totalRomanentHours += Math.floor(totalRomanentMinutes / 60); totalRomanentMinutes %= 60;
      const totalWorkedHours = totalPlannedHoursFixed - VACATION_HOURS;

      const plannedMinutes = Math.round(totalPlannedHoursFixed * 60);
      totalPlannedHoursSpan.textContent = `${Math.floor(plannedMinutes/60)} h ${(plannedMinutes%60).toString().padStart(2,'0')} m`;
      const workedMinutes = Math.round(totalWorkedHours * 60);
      totalWorkedHoursSpan.textContent = `${Math.floor(workedMinutes/60)} h ${(workedMinutes%60).toString().padStart(2,'0')} m`;
      totalVacancesHoursSpan.textContent = `${VACATION_HOURS} h 00 m`;
      totalWorkedDaysSpan.textContent = `${totalWorkedDaysFixed} dies`;
      totalPerllongamentHoursSpan.textContent = `${totalPerllongamentHours} h ${totalPerllongamentMinutes.toString().padStart(2,'0')} m`;
      totalRomanentFetHoursSpan.textContent = `${totalRomanentHours} h ${totalRomanentMinutes.toString().padStart(2,'0')} m`;
      totalRomanentFetHoursSpan.classList.add('text-blue-500');

      const netBalanceMinutes = Math.round((totalWorkedHours - ANNUAL_WORK_HOURS) * 60);
      if (netBalanceMinutes < 0) {
        const displayRomanentPerFerMinutes = Math.abs(netBalanceMinutes);
        const h = Math.floor(displayRomanentPerFerMinutes/60);
        const m = (displayRomanentPerFerMinutes%60).toString().padStart(2,'0');
        totalRomanentPerFerHoursSpan.textContent = `${h} h ${m} m`;
        totalRomanentPerFerHoursSpan.classList.add('text-red-500');
      } else {
        totalRomanentPerFerHoursSpan.textContent = `0 h 00 m`;
        totalRomanentPerFerHoursSpan.classList.remove('text-red-500');
      }

      totalJudicisSpan.textContent = totalJuicios;
      summaryTitle.textContent = `Resum Anual (1 de Febrer de 2025 - 31 de Gener de 2026)`;
    }

    // ---------- Event handlers ----------
    calendarGrid.addEventListener('click', (event) => {
      const dayBox = event.target.closest('.day-box');
      if (!dayBox || !dayBox.dataset.date) return;
      if (dayBox.classList.contains('faded')) {
        const clickedDate = new Date(dayBox.dataset.date);
        const currentMonth = parseInt(monthSelect.value);
        const currentYear = parseInt(yearSelect.value);
        const firstDayOfCurrentMonth = new Date(currentYear, currentMonth, 1);
        if (clickedDate.getTime() > firstDayOfCurrentMonth.getTime()) updateMonth(1); else updateMonth(-1);
        return;
      }
      selectedDayDate = dayBox.dataset.date;
      annotationModal.classList.remove('hidden');
    });

    annotationOptions.addEventListener('click', (event) => {
      const annotation = event.target.dataset.annotation;
      if (!annotation) return;
      if (annotation === 'Perllongament' || annotation === 'Romanent') {
        annotationModal.classList.add('hidden');
        timeModal.classList.remove('hidden');
        currentAnnotationType = annotation;
        timeModalTitle.textContent = `Afegeix hores de ${annotation}`;
        timeModalMotivoContainer.classList.remove('hidden');
        const existing = annotations[selectedDayDate];
        if (existing && existing.type === annotation) {
          timeHoursInput.value = existing.hours || 0;
          timeMinutesInput.value = existing.minutes || 0;
          timeMotivoInput.value = existing.motivo || '';
        } else {
          timeHoursInput.value = 0; timeMinutesInput.value = 0; timeMotivoInput.value = '';
        }
      } else {
        saveAnnotation(selectedDayDate, { type: annotation });
        annotationModal.classList.add('hidden');
      }
    });

    clearAnnotationBtn.addEventListener('click', () => {
      deleteAnnotationForEscamot(selectedDayDate);
      annotationModal.classList.add('hidden');
    });

    closeModalBtn.addEventListener('click', () => annotationModal.classList.add('hidden'));

    saveTimeBtn.addEventListener('click', () => {
      const hours = parseInt(timeHoursInput.value) || 0;
      const minutes = parseInt(timeMinutesInput.value) || 0;
      const motivo = (timeMotivoInput.value || '').trim();
      if (hours === 0 && minutes === 0) {
        deleteAnnotationForEscamot(selectedDayDate);
      } else {
        saveAnnotation(selectedDayDate, { type: currentAnnotationType, hours, minutes, motivo });
      }
      timeModal.classList.add('hidden');
    });

    cancelTimeBtn.addEventListener('click', () => timeModal.classList.add('hidden'));

    // ---------- Init & auth ----------
    document.addEventListener('DOMContentLoaded', () => {
      populateMonthYearSelects();
      goToToday();
    });

    escamotSelect.addEventListener('change', () => {
      // Cambia la suscripción y renderiza
      if (userId) subscribeAnnotations(escamotSelect.value);
      else renderCalendar();
    });
    monthSelect.addEventListener('change', renderCalendar);
    yearSelect.addEventListener('change', renderCalendar);
    prevMonthBtn.addEventListener('click', () => updateMonth(-1));
    nextMonthBtn.addEventListener('click', () => updateMonth(1));
    todayBtn.addEventListener('click', goToToday);

    // Autenticación anónima (asegúrate que esté activada en Firebase Console)
    signInAnonymously(auth).then((result) => {
      userId = result.user.uid;
      isAuthReady = true;
      userIdDisplay.textContent = `ID de Usuario: ${userId}`;
      statusMessage.textContent = "Conectado. Anotaciones guardadas en tu cuenta.";
      // iniciar suscripción por el escamot actual
      subscribeAnnotations(escamotSelect.value);
    }).catch((error) => {
      console.error("Authentication error:", error);
      statusMessage.textContent = "Error de autenticación.";
    });
  </script>
</body>
</html>



