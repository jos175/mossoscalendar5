<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mossos Calendar</title>
  <style>
    /* Estilos generales */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 10px;
      text-align: center;
      width: 100%;
    }
    #controls {
      display: flex;
      gap: 10px;
      margin: 10px;
      align-items: center;
    }
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      width: 90%;
      max-width: 1000px;
    }
    .day {
      background-color: white;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      position: relative;
    }
    .annotation {
      font-size: 0.8em;
      margin-top: 5px;
      color: #333;
    }
    .highlight {
      background-color: #ffeb3b;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 300px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    /* Auth buttons */
    #auth-buttons, #user-panel {
      margin-top: 1rem;
      text-align: center;
    }
    .auth-btn {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 4px;
    }
    .auth-btn:hover {
      background-color: #0056b3;
    }
    #user-panel span {
      margin-right: 0.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>MOSSOS CALENDAR</h1>
  </header>

  <div id="controls">
    <select id="escamot-select">
      <option value="1">Escamot 1</option>
      <option value="2">Escamot 2</option>
      <option value="3">Escamot 3</option>
    </select>
    <button id="today-btn">Avui</button>
    <select id="month-select"></select>
    <select id="year-select"></select>
    <button id="prev-month-btn">&lt;</button>
    <button id="next-month-btn">&gt;</button>
  </div>

  <p id="today-date"></p>

  <div id="calendar"></div>

  <!-- Modal de anotaciones -->
  <div id="annotation-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Selecciona una anotació</h3>
      <button class="annotation-option" data-annotation="Perllongament">Perllongament</button>
      <button class="annotation-option" data-annotation="Romanent">Romanent</button>
      <button class="annotation-option" data-annotation="Lliure">Lliure</button>
      <button class="annotation-option" data-annotation="Torn">Torn</button>
      <button id="clear-annotation-btn">Treure anotació</button>
      <button id="close-modal-btn">Cancel·lar</button>
    </div>
  </div>

  <!-- Modal de hores -->
  <div id="time-modal" class="modal hidden">
    <div class="modal-content">
      <h3 id="time-modal-title">Afegeix hores</h3>
      <label>
        Hores:
        <input type="number" id="time-hours" min="0" value="0" />
      </label>
      <br />
      <label>
        Minuts:
        <input type="number" id="time-minutes" min="0" value="0" />
      </label>
      <br />
      <label id="time-motivo-container">
        Motiu:
        <input type="text" id="time-motivo" placeholder="Descripció" />
      </label>
      <br /><br />
      <button id="save-time-btn">Guardar</button>
      <button id="cancel-time-btn">Cancel·lar</button>
    </div>
  </div>

  <!-- Auth section -->
  <div id="auth-buttons">
    <p>Inicia sessió o crea un compte:</p>
    <button id="google-signin-btn" class="auth-btn">Google</button>
    <button id="email-open-modal-btn" class="auth-btn">Email/Password</button>
  </div>

  <div id="user-panel" class="hidden">
    <span id="user-email-span"></span>
    <button id="signout-btn" class="auth-btn">Tancar sessió</button>
  </div>

  <!-- Email modal -->
  <div id="email-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Entra / Crea compte</h3>
      <input type="email" id="email-input" placeholder="Email" />
      <br><br>
      <input type="password" id="password-input" placeholder="Contrasenya" />
      <br><br>
      <button id="email-create-btn" class="auth-btn">Crear compte</button>
      <button id="email-signin-btn" class="auth-btn">Entrar</button>
      <button id="email-close-btn" class="auth-btn">Tancar</button>
    </div>
  </div>

  <p id="status-message">Connectant...</p>
  <p id="user-id-display"></p>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      linkWithRedirect,
      EmailAuthProvider,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      linkWithCredential,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ✅ CONFIGURACIÓN FIREBASE (MISMA QUE TENÍAS)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "mossoscalendar.firebaseapp.com",
      projectId: "mossoscalendar",
      storageBucket: "mossoscalendar.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYY"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elementos del DOM
    const escamotSelect = document.getElementById("escamot-select");
    const monthSelect = document.getElementById("month-select");
    const yearSelect = document.getElementById("year-select");
    const prevMonthBtn = document.getElementById("prev-month-btn");
    const nextMonthBtn = document.getElementById("next-month-btn");
    const todayBtn = document.getElementById("today-btn");
    const todayDateDisplay = document.getElementById("today-date");
    const calendar = document.getElementById("calendar");

    const annotationModal = document.getElementById("annotation-modal");
    const annotationOptions = annotationModal.querySelector(".modal-content");
    const clearAnnotationBtn = document.getElementById("clear-annotation-btn");
    const closeModalBtn = document.getElementById("close-modal-btn");

    const timeModal = document.getElementById("time-modal");
    const timeModalTitle = document.getElementById("time-modal-title");
    const timeHoursInput = document.getElementById("time-hours");
    const timeMinutesInput = document.getElementById("time-minutes");
    const timeMotivoInput = document.getElementById("time-motivo");
    const saveTimeBtn = document.getElementById("save-time-btn");
    const cancelTimeBtn = document.getElementById("cancel-time-btn");
    const timeModalMotivoContainer = document.getElementById("time-motivo-container");

    const googleSignInBtn = document.getElementById("google-signin-btn");
    const emailOpenBtn = document.getElementById("email-open-modal-btn");
    const emailModal = document.getElementById("email-modal");
    const emailCloseBtn = document.getElementById("email-close-btn");
    const emailCreateBtn = document.getElementById("email-create-btn");
    const emailSigninBtn = document.getElementById("email-signin-btn");
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");

    const authButtons = document.getElementById("auth-buttons");
    const userPanel = document.getElementById("user-panel");
    const userEmailSpan = document.getElementById("user-email-span");
    const signOutBtn = document.getElementById("signout-btn");
    const statusMessage = document.getElementById("status-message");
    const userIdDisplay = document.getElementById("user-id-display");

    // Variables globales
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDayDate = null;
    let currentAnnotationType = null;
    let userId = null;
    let isAuthReady
        = false;

    // Inicialización de meses y años
    const months = [
      "Gener", "Febrer", "Març", "Abril", "Maig", "Juny",
      "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"
    ];
    function populateMonthYear() {
      monthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
      monthSelect.value = currentMonth;

      yearSelect.innerHTML = '';
      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
      }
      yearSelect.value = currentYear;
    }

    populateMonthYear();

    // Mostrar fecha de hoy
    function updateTodayDate() {
      const today = new Date();
      todayDateDisplay.textContent = `Avui: ${today.toLocaleDateString("ca-ES")}`;
    }
    updateTodayDate();

    // Render del calendario
    function renderCalendar() {
      calendar.innerHTML = '';
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        calendar.innerHTML += '<div class="day empty"></div>';
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        dayDiv.textContent = day;
        dayDiv.dataset.date = `${currentYear}-${currentMonth + 1}-${day}`;
        calendar.appendChild(dayDiv);
      }
    }

    renderCalendar();

    // Botones de navegación
    prevMonthBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      renderCalendar();
    });

    todayBtn.addEventListener('click', () => {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      renderCalendar();
    });

    monthSelect.addEventListener('change', () => {
      currentMonth = parseInt(monthSelect.value);
      renderCalendar();
    });

    yearSelect.addEventListener('change', () => {
      currentYear = parseInt(yearSelect.value);
      renderCalendar();
    });

    // 🔑 Autenticación Google
    const provider = new GoogleAuthProvider();
    googleSignInBtn.addEventListener('click', () => {
      signInWithRedirect(auth, provider);
    });

    // Email/Password modal
    emailOpenBtn.addEventListener('click', () => {
      emailModal.classList.remove('hidden');
    });
    emailCloseBtn.addEventListener('click', () => {
      emailModal.classList.add('hidden');
    });

    emailCreateBtn.addEventListener('click', async () => {
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        emailModal.classList.add('hidden');
      } catch (error) {
        alert(error.message);
      }
    });

    emailSigninBtn.addEventListener('click', async () => {
      try {
        const userCredential = await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        emailModal.classList.add('hidden');
      } catch (error) {
        alert(error.message);
      }
    });

    // Logout
    signOutBtn.addEventListener('click', async () => {
      await signOut(auth);
    });

    // Observador de estado de autenticación
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        userEmailSpan.textContent = user.email || "Anònim";
        authButtons.classList.add('hidden');
        userPanel.classList.remove('hidden');
        statusMessage.textContent = "Connectat";
        userIdDisplay.textContent = `UID: ${userId}`;
      } else {
        authButtons.classList.remove('hidden');
        userPanel.classList.add('hidden');
        statusMessage.textContent = "Desconnectat";
        userIdDisplay.textContent = "";
        userId = null;
      }
    });

    // Click en día para anotación
    calendar.addEventListener('click', (e) => {
      if (!e.target.classList.contains('day')) return;
      selectedDayDate = e.target.dataset.date;
      annotationModal.classList.remove('hidden');
    });

    // Opciones de anotación
    annotationModal.querySelectorAll('.annotation-option').forEach(btn => {
      btn.addEventListener('click', async () => {
        const annotation = btn.dataset.annotation;
        await setAnnotation(annotation);
        annotationModal.classList.add('hidden');
      });
    });

    clearAnnotationBtn.addEventListener('click', async () => {
      await setAnnotation(null);
      annotationModal.classList.add('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
      annotationModal.classList.add('hidden');
    });

    async function setAnnotation(annotation) {
      if (!userId || !selectedDayDate) return;
      const docRef = doc(db, `users/${userId}/annotations/${selectedDayDate}`);
      if (annotation) {
        await setDoc(docRef, { type: annotation });
      } else {
        await setDoc(docRef, { type: "" });
      }
      renderCalendar();
    }

  </script>
</body>
</html>







