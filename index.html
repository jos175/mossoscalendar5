<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mossos calendar by JPL</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
  .day-box { min-height: 90px; display:flex; flex-direction:column; justify-content:space-between; align-items:center; padding:8px; text-align:center; cursor:pointer; transition:transform 0.1s ease-in-out; }
  .day-box:hover { transform: scale(1.02); }
  .day-box.faded { opacity:0.5; cursor:pointer; transform:none; }
  .day-box.annotation-highlight { border-width:2px; border-color:#000; }
  .day-number { font-weight:600; font-size:1.25rem; }
  .day-shift { font-size:0.875rem; line-height:1; }
  .day-annotation { font-size:0.75rem; font-weight:500; color:#4B5563; padding-left:4px; padding-right:4px; padding-bottom:6px; word-wrap:break-word; line-height:1.1; }
  .button { padding:8px 16px; font-weight:500; border-radius:9999px; transition:background-color 0.15s ease-in-out; }
  .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:50; }
  .modal-content { background:#fff; padding:24px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,.1),0 10px 15px rgba(0,0,0,.1); width:90%; max-width:420px; text-align:center; }
  .modal-button { display:block; width:100%; padding:12px; margin-top:8px; border-radius:8px; background:#E5E7EB; color:#1F2937; font-weight:600; transition:background-color .15s; }
  .modal-button:hover { background:#D1D5DB; }
  .input-group { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .input-group label { font-weight:500; color:#4B5563; }
  .input-group input, .input-group textarea { width:45%; padding:8px; border-radius:8px; border:1px solid #D1D5DB; text-align:center; }
  .total-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #E5E7EB; }
  .total-item:last-child { border-bottom:none; }
  .total-item span:first-child { font-weight:500; color:#4B5563; }
  .total-item span:last-child { font-weight:600; color:#1F2937; }
  @media (max-width:640px) {
    .day-box { min-height:80px; padding:6px; }
    .day-number { font-size:1.1rem; }
    .day-shift { font-size:0.75rem; }
    .day-annotation { font-size:0.65rem; padding-bottom:2px; }
    h1 { font-size:1.75rem; }
  }
  .user-id { font-size:0.75rem; color:#6B7280; margin-top:1rem; text-align:center; word-break:break-all; }
  .status-message { margin-top:0.5rem; font-size:0.875rem; color:#4B5563; text-align:center; }
  .auth-btn { padding:6px 10px; border-radius:8px; font-weight:600; border:1px solid #E5E7EB; background:white; }
  .small-muted { font-size:0.8rem; color:#6B7280; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

<div class="w-full max-w-4xl bg-white p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-200">
  <div class="flex items-start justify-between mb-4">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-1">Mossos calendar by JPL</h1>
      <div class="small-muted">Gestiona les teves anotacions i hores</div>
    </div>
    <div class="flex flex-col items-end space-y-2">
      <div id="auth-buttons" class="flex space-x-2">
        <button id="google-signin-btn" class="auth-btn">Google</button>
        <button id="email-open-btn" class="auth-btn">Email</button>
      </div>
      <div id="user-panel" class="hidden text-right">
        <div class="text-sm text-gray-700" id="user-email"></div>
        <div class="flex items-center space-x-2">
          <button id="sign-out-btn" class="button bg-red-500 hover:bg-red-600 text-white">Tancar sessió</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Selección de escamot, mes y año -->
  <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0 md:space-x-4">
    <div class="flex-grow w-full md:w-auto">
      <label for="escamot-select" class="block text-sm font-medium text-gray-700 mb-1">Selecciona el teu Escamot</label>
      <select id="escamot-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
        <option value="1">Escamot 1</option>
        <option value="2">Escamot 2</option>
        <option value="3">Escamot 3</option>
        <option value="4">Escamot 4</option>
        <option value="5">Escamot 5</option>
      </select>
    </div>

    <div class="flex flex-grow w-full md:w-auto mt-4 md:mt-0 space-x-2">
      <div class="flex-1">
        <label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Mes</label>
        <select id="month-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
      </div>
      <div class="flex-1">
        <label for="year-select" class="block text-sm font-medium text-gray-700 mb-1">Any</label>
        <select id="year-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
      </div>
    </div>
  </div>

  <div class="flex justify-between mb-4 items-center">
    <button id="prev-month-btn" class="button bg-gray-300 hover:bg-gray-400 text-gray-800">&lt; Mes Anterior</button>
    <div class="flex items-center space-x-3">
      <button id="today-btn" class="button bg-indigo-600 hover:bg-indigo-700 text-white">Avui</button>
      <span id="today-date" class="text-sm sm:text-base text-gray-700 font-medium"></span>
    </div>
    <button id="next-month-btn" class="button bg-gray-300 hover:bg-gray-400 text-gray-800">Mes Següent &gt;</button>
  </div>

  <div id="calendar-container">
    <div class="grid grid-cols-7 text-center font-bold text-gray-700 bg-gray-200 rounded-t-lg p-2">
      <div>Dill</div><div>Dim</div><div>Dmc</div><div>Dij</div><div>Div</div><div>Dis</div><div>Diu</div>
    </div>
    <div id="calendar-grid" class="grid grid-cols-7 gap-1 p-1 sm:p-2 bg-white rounded-b-lg border border-gray-200"></div>
  </div>

  <p class="status-message" id="status-message">Conectando...</p>
  <p class="user-id" id="user-id">ID de Usuario: Cargando...</p>

  <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
    <h2 id="summary-title" class="text-xl font-bold text-gray-800 mb-4">Resum Anual</h2>
    <div id="totals-display">
      <div class="total-item"><span>Total d'hores planificades:</span><span id="total-planned-hours">0 h</span></div>
      <div class="total-item"><span>Total d'hores treballades:</span><span id="total-worked-hours">0 h</span></div>
      <div class="total-item"><span>Total d'hores que s'han de treballar a l'any:</span><span id="total-annual-hours">1680 h</span></div>
      <div class="total-item"><span>Total de vacances:</span><span id="total-vacances-hours">0 h</span></div>
      <div class="total-item"><span>Total de dies treballats:</span><span id="total-worked-days">0 dies</span></div>
      <div class="total-item"><span>Total d'hores de perllongament:</span><span id="total-perllongament-hours">0 h 0 m</span></div>
      <div class="total-item"><span>Romanent per fer any:</span><span id="total-romanent-per-fer-hours" class="font-bold">0 h</span></div>
    </div>
  </div>
</div>

<!-- Modal anotaciones -->
<div id="annotation-modal" class="hidden modal-overlay">
  <div class="modal-content">
    <h3 class="text-lg font-bold mb-4">Afegir / Editar Anotació</h3>
    <textarea id="annotation-text" rows="4" class="w-full border p-2 rounded-md mb-4"></textarea>
    <button id="save-annotation-btn" class="modal-button bg-indigo-600 text-white">Guardar</button>
    <button id="close-annotation-btn" class="modal-button">Tancar</button>
  </div>
</div>

<!-- Firebase & Google Auth scripts -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, linkWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TU_API_KEY",
  authDomain: "TU_PROJECT.firebaseapp.com",
  projectId: "TU_PROJECT",
  storageBucket: "TU_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusMessage = document.getElementById('status-message');
const userIdDisplay = document.getElementById('user-id');
const userEmailDisplay = document.getElementById('user-email');
const authButtons = document.getElementById('auth-buttons');
const userPanel = document.getElementById('user-panel');

let annotationsData = {}; // Local cache de anotaciones
let currentDaySelected = null;

// --- Funciones Firebase ---
async function fetchAllAnnotationsForUserUid(uid) {
  const docSnap = await getDoc(doc(db, 'annotations', uid));
  return docSnap.exists() ? docSnap.data() : {};
}

async function writeAnnotationsToUserUid(uid, data) {
  await setDoc(doc(db, 'annotations', uid), data);
}

// --- Auth ---
async function ensureAnonymousUser() {
  if (!auth.currentUser) {
    await signInAnonymously(auth);
  }
}

document.getElementById('google-signin-btn').addEventListener('click', async () => {
  const provider = new GoogleAuthProvider();
  try {
    if (auth.currentUser && auth.currentUser.isAnonymous) {
      const anonUid = auth.currentUser.uid;
      const anonData = await fetchAllAnnotationsForUserUid(anonUid);
      try {
        await linkWithPopup(auth.currentUser, provider);
        statusMessage.textContent = "Cuenta Google vinculada correctamente (datos preservados).";
      } catch (err) {
        const res = await signInWithPopup(auth, provider);
        const newUid = res.user.uid;
        if (newUid !== anonUid) {
          await writeAnnotationsToUserUid(newUid, anonData);
          statusMessage.textContent = "Datos anónimos copiados a tu cuenta Google.";
        }
      }
    } else {
      await signInWithPopup(auth, provider);
    }
  } catch (err) {
    console.error("Error Google sign-in:", err);
    statusMessage.textContent = "Error en inicio con Google.";
  }
});

document.getElementById('sign-out-btn').addEventListener('click', async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, async user => {
  if (!user) return;
  userIdDisplay.textContent = `ID de Usuario: ${user.uid}`;
  if (user.isAnonymous) {
    authButtons.style.display = 'flex';
    userPanel.classList.add('hidden');
    statusMessage.textContent = 'Conectado como usuario anónimo.';
  } else {
    authButtons.style.display = 'none';
    userPanel.classList.remove('hidden');
    userEmailDisplay.textContent = user.email || '';
    statusMessage.textContent = 'Conectado como usuario Google.';
  }
  annotationsData = await fetchAllAnnotationsForUserUid(user.uid);
  renderCalendar();
});

// --- Calendario ---
const calendarGrid = document.getElementById('calendar-grid');
const monthSelect = document.getElementById('month-select');
const yearSelect = document.getElementById('year-select');
const todayDate = document.getElementById('today-date');

const now = new Date();
let currentMonth = now.getMonth();
let currentYear = now.getFullYear();

function populateMonthYearSelectors() {
  monthSelect.innerHTML = '';
  for (let m=0; m<12; m++) {
    const opt = document.createElement('option');
    opt.value = m;
    opt.text = new Date(0, m).toLocaleString('ca', { month:'long' });
    if (m === currentMonth) opt.selected = true;
    monthSelect.appendChild(opt);
  }
  yearSelect.innerHTML = '';
  for (let y=currentYear-5; y<=currentYear+5; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.text = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }
}
populateMonthYearSelectors();

monthSelect.addEventListener('change', () => { currentMonth = parseInt(monthSelect.value); renderCalendar(); });
yearSelect.addEventListener('change', () => { currentYear = parseInt(yearSelect.value); renderCalendar(); });
document.getElementById('prev-month-btn').addEventListener('click', () => { currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--; yearSelect.value=currentYear;} monthSelect.value=currentMonth; renderCalendar(); });
document.getElementById('next-month-btn').addEventListener('click', () => { currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++; yearSelect.value=currentYear;} monthSelect.value=currentMonth; renderCalendar(); });
document.getElementById('today-btn').addEventListener('click', () => { currentMonth=now.getMonth(); currentYear=now.getFullYear(); monthSelect.value=currentMonth; yearSelect.value=currentYear; renderCalendar(); });

function renderCalendar() {
  calendarGrid.innerHTML = '';
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  for (let i=0;i<firstDay;i++) {
    const div = document.createElement('div'); div.classList.add('day-box','faded'); calendarGrid.appendChild(div);
  }
  for (let d=1; d<=daysInMonth; d++) {
    const div = document.createElement('div'); div.classList.add('day-box');
    const spanNum = document.createElement('div'); spanNum.classList.add('day-number'); spanNum.textContent=d; div.appendChild(spanNum);
    const annText = annotationsData[`${currentYear}-${currentMonth+1}-${d}`]||'';
    if(annText){ div.classList.add('annotation-highlight'); }
    const spanAnn = document.createElement('div'); spanAnn.classList.add('day-annotation'); spanAnn.textContent=annText; div.appendChild(spanAnn);
    div.addEventListener('click', () => openAnnotationModal(d));
    calendarGrid.appendChild(div);
  }
  todayDate.textContent = new Date(currentYear, currentMonth, 1).toLocaleDateString('ca', {month:'long', year:'numeric'});
}

function openAnnotationModal(day) {
  currentDaySelected = day;
  const modal = document.getElementById('annotation-modal');
  const textarea = document.getElementById('annotation-text');
  textarea.value = annotationsData[`${currentYear}-${currentMonth+1}-${day}`]||'';
  modal.classList.remove('hidden');
}
document.getElementById('close-annotation-btn').addEventListener('click', () => { document.getElementById('annotation-modal').classList.add('hidden'); });
document.getElementById('save-annotation-btn').addEventListener('click', async () => {
  const text = document.getElementById('annotation-text').value;
  annotationsData[`${currentYear}-${currentMonth+1}-${currentDaySelected}`] = text;
  if(auth.currentUser) await writeAnnotationsToUserUid(auth.currentUser.uid, annotationsData);
  document.getElementById('annotation-modal').classList.add('hidden');
  renderCalendar();
});

ensureAnonymousUser();
</script>
</body>
</html>


